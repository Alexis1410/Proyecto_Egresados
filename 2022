function main(workbook: ExcelScript.Workbook) {
    // === CONFIG ===
    const SHEETS: string[] = ["egresados enero-junio-2022", "egresados agosto-dic-2022"];
    const OUT = "Base 2022";
    const RESP_SHEET = "Respondieron"; // se usarÃ¡ o se crearÃ¡
    const RESP_COL_LETTER = "B";       // correos en Respondieron

    // === SALIDA LIMPIA ===
    let out: ExcelScript.Worksheet = workbook.getWorksheet(OUT);
    if (out) out.delete();
    out = workbook.addWorksheet(OUT);

    // Quitamos MINUSC PERS / MINUSC INST del encabezado ðŸ‘‡
    const HEADERS: string[] = [
        "Alumno", "Sexo", "Edad Actual", "Periodo de egreso", "Periodo de ingreso",
        "Correo personal", "Correo institucional", "Celular", "Carrera", "Modalidad",
        "RESPONDIO", "Tot Si", "Tot No", "OrigenHoja"
    ];
    out.getRange("A1").getResizedRange(0, HEADERS.length - 1).setValues([HEADERS]);

    // === 1) LEER / CREAR Respondieron ===
    let respWs: ExcelScript.Worksheet = workbook.getWorksheet(RESP_SHEET);
    const respondedSet: Set<string> = new Set<string>();

    if (respWs) {
        const usedCol: ExcelScript.Range = respWs.getRange(`${RESP_COL_LETTER}:${RESP_COL_LETTER}`).getUsedRange();
        if (usedCol) {
            const vals: (string | number | boolean)[][] = usedCol.getValues();
            for (let r = 1; r < vals.length; r++) {
                const v: string = (vals[r][0] ?? "").toString().trim().toLowerCase();
                if (v && v.includes("@")) respondedSet.add(v);
            }
        }
    } else {
        // Crear tomando "SÃ­/RespondiÃ³" desde las hojas fuente (detectando encabezado)
        respWs = workbook.addWorksheet(RESP_SHEET);
        respWs.getRange(`${RESP_COL_LETTER}1`).setValue("Correo");

        const provisional: Set<string> = new Set<string>();
        for (const sh of SHEETS) {
            const ws: ExcelScript.Worksheet = workbook.getWorksheet(sh);
            if (!ws) continue;
            const used: ExcelScript.Range = ws.getUsedRange();
            if (!used) continue;
            const data: (string | number | boolean)[][] = used.getValues();
            if (data.length < 2) continue;

            const headRow: number = detectHeaderRow(data);
            const header: string[] = rowToLower(data[headRow]);

            const iResp: number = find(header, ["respondio", "respondiÃ³", "respond"]);
            const iCP: number = find(header, ["correo personal"]);
            const iCI: number = find(header, ["correo itq", "correo institucional"]);

            if (iResp < 0 || (iCP < 0 && iCI < 0)) continue;

            for (let r = headRow + 1; r < data.length; r++) {
                const respTok: string = normalizeText(data[r][iResp]);
                if (respTok === "si" || respTok === "respondio") {
                    const cp = normalizeEmail(data[r][iCP]);
                    const ci = normalizeEmail(data[r][iCI]);
                    if (cp) provisional.add(cp);
                    if (ci) provisional.add(ci);
                }
            }
        }
        let rr = 2;
        for (const mail of provisional) {
            respWs.getRange(`${RESP_COL_LETTER}${rr}`).setValue(mail);
            respondedSet.add(mail);
            rr++;
        }
    }

    // === 2) UNIFICAR HOJAS (detectando encabezado) ===
    let nextRow = 2;

    for (const sh of SHEETS) {
        const ws: ExcelScript.Worksheet = workbook.getWorksheet(sh);
        if (!ws) continue;
        const used: ExcelScript.Range = ws.getUsedRange();
        if (!used) continue;

        const data: (string | number | boolean)[][] = used.getValues();
        if (data.length < 2) continue;

        const headRow: number = detectHeaderRow(data);
        const header: string[] = rowToLower(data[headRow]);

        const iAlumno = find(header, ["alumno"]);
        const iSexo = find(header, ["sexo"]);
        const iEdad = find(header, ["edad actual", "edad"]);
        const iPerEgr = find(header, ["periodo de egreso"]);
        const iPerIng = find(header, ["periodo de ingreso"]);
        const iCP = find(header, ["correo personal"]);
        const iCI = find(header, ["correo itq", "correo institucional"]);
        const iCel = find(header, ["celular"]);
        const iCarr = find(header, ["carrera"]);
        const iMod = find(header, ["modalidad"]);

        for (let r = headRow + 1; r < data.length; r++) {
            if (isRowEmpty(data[r], [iAlumno, iCP, iCI])) continue;

            const alumno = toTitle((data[r][iAlumno] ?? "").toString());
            const sexo = (data[r][iSexo] ?? "").toString();
            const edad = (data[r][iEdad] ?? "").toString();
            const perEgr = (data[r][iPerEgr] ?? "").toString();
            const perIng = (data[r][iPerIng] ?? "").toString();
            const cpRaw = (data[r][iCP] ?? "").toString();
            const ciRaw = (data[r][iCI] ?? "").toString();
            const cel = (data[r][iCel] ?? "").toString();
            const carr = (data[r][iCarr] ?? "").toString();
            const mod = (data[r][iMod] ?? "").toString();

            // Normalizamos solo para comparar, NO se escribe
            const cpLow = normalizeEmail(cpRaw);
            const ciLow = normalizeEmail(ciRaw);
            const resp = (cpLow && respondedSet.has(cpLow)) || (ciLow && respondedSet.has(ciLow)) ? "SÃ­" : "No";

            // Quitados MINUSC PERS/INST: ajustamos el orden:
            const outRow: (string | number | boolean)[] = [
                alumno, sexo, edad, perEgr, perIng,
                cpRaw, ciRaw, cel, carr, mod,
                resp, "", "", sh // Tot Si, Tot No se llenan despuÃ©s
            ];
            out.getCell(nextRow - 1, 0).getResizedRange(0, HEADERS.length - 1).setValues([outRow]);
            nextRow++;
        }
    }

    // === 3) Totales SÃ­/No
    const usedOut: ExcelScript.Range = out.getUsedRange();
    const valsOut: (string | number | boolean)[][] = usedOut.getValues();
    const hdr: string[] = rowToLower(valsOut[0]);
    const iResp = hdr.indexOf("respondio");
    const iTotSi = hdr.indexOf("tot si");
    const iTotNo = hdr.indexOf("tot no");

    let totSi = 0, totNo = 0;
    for (let r = 1; r < valsOut.length; r++) {
        const t = normalizeText(valsOut[r][iResp]);
        if (t === "si") totSi++;
        else if (t === "no") totNo++;
    }
    for (let r = 1; r < valsOut.length; r++) {
        valsOut[r][iTotSi] = totSi;
        valsOut[r][iTotNo] = totNo;
    }
    usedOut.setValues(valsOut);

    // === 4) Tabla y formato
    const tbl = out.addTable(out.getUsedRange(), true);
    tbl.setName("tblBase2022");
    tbl.setPredefinedTableStyle("TableStyleMedium9");
    out.getFreezePanes().freezeRows(1);
    out.getUsedRange()?.getFormat().autofitColumns();

    // ===== Helpers =====
    function detectHeaderRow(data: (string | number | boolean)[][]): number {
        const maxScan = Math.min(10, data.length);
        let bestRow = 0, bestScore = -1;
        const keys = ["alumno", "correo personal", "correo itq", "correo institucional", "carrera", "periodo de egreso"];
        for (let r = 0; r < maxScan; r++) {
            const row = rowToLower(data[r]);
            let score = 0;
            for (const k of keys) if (row.some(h => h.includes(k))) score++;
            if (score > bestScore) { bestScore = score; bestRow = r; }
        }
        return bestRow;
    }
    function rowToLower(row: (string | number | boolean)[]): string[] {
        return row.map(v => (v ?? "").toString().toLowerCase().trim());
    }
    function find(header: string[], keys: string[]): number {
        for (let i = 0; i < header.length; i++) {
            const h = header[i];
            for (const k of keys) if (h.includes(k)) return i;
        }
        return -1;
    }
    function normalizeEmail(v: unknown): string {
        const s0: string = (v === null || v === undefined) ? "" : String(v);
        const m: RegExpMatchArray | null = s0.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
        const s1: string = (m ? m[0] : s0).toLowerCase();
        return s1.replace(/\s+/g, "").trim();
    }
    function normalizeText(v: unknown): string {
        return (v ?? "").toString().toLowerCase().trim()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }
    function isRowEmpty(row: (string | number | boolean)[], cols: number[]): boolean {
        for (const c of cols) {
            if (c >= 0) {
                const s = (row[c] ?? "").toString().trim();
                if (s) return false;
            }
        }
        return true;
    }
    function toTitle(raw: string): string {
        const s = (raw ?? "").toString().toLowerCase().trim();
        if (!s) return "";
        const keep = new Set(["de", "del", "la", "las", "los", "y", "e"]);
        return s.split(/\s+/).map((w, i) => (i > 0 && keep.has(w) ? w : w.charAt(0).toUpperCase() + w.slice(1))).join(" ");
    }
}
